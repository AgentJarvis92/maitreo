<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maitreo | Onboarding</title>
    <script src="https://cdn.tailwindcss.com/3.4.17"></script>
    <style>
        :root { --font-main: 'Helvetica Neue', Helvetica, Arial, sans-serif; --c-bg: #121212; }
        body {
            font-family: var(--font-main);
            background-color: var(--c-bg);
            color: white;
            overflow-x: hidden;
            background-image:
                linear-gradient(160deg, rgba(0,0,0,0.62) 0%, rgba(0,0,0,0.75) 100%),
                url('https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?q=80&w=2787&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
        }
        @media (max-width: 639px) {
            body { overflow: hidden; height: 100vh; width: 100vw; min-height: unset; }
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #333; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .glass-header {
            background: rgba(0,0,0,0.15);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .glass-panel {
            background: rgba(255,255,255,0.04);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.06);
            box-shadow: 0 12px 56px rgba(0,0,0,0.32), 0 1px 0 rgba(255,255,255,0.04) inset;
        }
        .form-input {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            transition: border-color 0.2s ease, background 0.2s ease;
        }
        .form-input:focus {
            background: rgba(255,255,255,0.07);
            border-color: rgba(255,255,255,0.45);
            outline: none;
        }
        .form-input.input-error {
            border-color: rgba(239,68,68,0.7);
        }
        .error-msg {
            color: #f87171;
            font-size: 10px;
            margin-top: 4px;
            display: none;
        }
        .error-msg.visible { display: block; }

        .progress-dot {
            width: 5px; height: 5px; border-radius: 50%;
            background: rgba(255,255,255,0.18);
            transition: background 0.3s, box-shadow 0.3s;
        }
        .progress-dot.completed { background: rgba(255,255,255,0.85); }
        .progress-dot.active-green {
            background: #4ade80;
            box-shadow: 0 0 6px rgba(74,222,128,0.6);
            animation: pulse-green 1.8s ease-in-out infinite;
        }
        @keyframes pulse-green { 0%,100%{opacity:1} 50%{opacity:0.6} }

        @keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
        .animate-fade-in { animation: fadeIn 0.6s ease-out forwards; }
        .delay-100 { animation-delay: 0.1s; }
        .delay-200 { animation-delay: 0.2s; }

        @keyframes checkDraw {
            from { stroke-dashoffset: 48; }
            to { stroke-dashoffset: 0; }
        }
        .check-animate { stroke-dasharray: 48; stroke-dashoffset: 48; animation: checkDraw 0.6s ease-out 0.3s forwards; }

        .step-section { display: none; }
        .step-section.active { display: block; }

        input::placeholder { color: rgba(255,255,255,0.2); }
        @media (max-width: 639px) { input::placeholder { font-size: 12px; } }

        .btn-primary {
            width: 100%; background: white; color: black; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.1em; font-size: 12px;
            transition: background 0.2s;
        }
        .btn-primary:hover { background: #f3f4f6; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        .resend-link {
            color: rgba(255,255,255,0.45);
            font-size: 11px;
            text-decoration: underline;
            text-underline-offset: 2px;
            cursor: pointer;
            transition: color 0.2s;
        }
        .resend-link:hover { color: rgba(255,255,255,0.7); }
    </style>
</head>
<body class="antialiased selection:bg-white selection:text-black flex flex-col">

    <!-- HEADER -->
    <nav class="fixed top-0 left-0 right-0 z-50 glass-header px-5 sm:px-8 py-4 sm:py-5 flex items-center justify-between">
        <div class="flex items-center gap-2 sm:gap-3">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="sm:w-7 sm:h-7" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="9" stroke="white" stroke-width="1.5"/>
                <path d="M12 6L12 18M8 9L16 9M8 15L16 15" stroke="white" stroke-width="1.5" stroke-linecap="square"/>
            </svg>
            <span class="text-xs sm:text-sm font-medium tracking-[0.15em] uppercase">Maitreo</span>
        </div>
    </nav>

    <!-- GRADIENT OVERLAY -->
    <div class="fixed inset-0 pointer-events-none z-0">
        <div class="absolute inset-0 bg-gradient-to-b from-black/60 via-transparent to-[#121212]"></div>
    </div>

    <!-- MAIN -->
    <main class="flex-grow flex items-center justify-center px-6 sm:px-4 py-24 sm:py-32 min-h-screen relative z-10">
        <div class="w-full max-w-sm sm:max-w-xl mx-auto">

            <!-- ==================== STEP 1: RESTAURANT BASICS ==================== -->
            <div id="step-1" class="step-section active">
                <div class="text-center mb-6 sm:mb-10 animate-fade-in opacity-0">
                    <span class="text-[10px] tracking-[0.25em] text-white/50 uppercase block mb-3 sm:mb-4">Onboarding</span>
                    <div class="flex items-center justify-center gap-2 mb-6 sm:mb-10" id="dots-1">
                        <div class="progress-dot active-green"></div>
                        <div class="progress-dot"></div>
                        <div class="progress-dot"></div>
                    </div>
                    <h1 class="text-2xl sm:text-5xl font-medium tracking-tight mb-2 sm:mb-4" style="letter-spacing:-0.02em">Set up your restaurant</h1>
                    <p class="text-xs sm:text-sm text-white/55 font-light leading-relaxed">You'll connect your Google Business Profile in the next step.</p>
                </div>

                <div class="glass-panel rounded-[20px] sm:rounded-xl p-4 sm:px-10 sm:py-10 animate-fade-in delay-100 opacity-0">
                    <form id="form-1" class="flex flex-col gap-3 sm:space-y-6" novalidate>
                        <div class="group">
                            <label class="text-[9px] sm:text-[10px] uppercase tracking-[0.15em] text-white/50 block mb-1.5 sm:mb-3 group-focus-within:text-white transition-colors">Restaurant Name</label>
                            <input type="text" name="name" class="form-input w-full px-3 sm:px-6 py-2.5 sm:py-4 text-sm text-white rounded-lg sm:rounded-none placeholder-white/20 font-light" placeholder="e.g. The Pepper Room" required>
                            <div class="error-msg" data-for="name"></div>
                        </div>
                        <div class="group">
                            <label class="text-[9px] sm:text-[10px] uppercase tracking-[0.15em] text-white/50 block mb-1.5 sm:mb-3 group-focus-within:text-white transition-colors">Owner Name</label>
                            <input type="text" name="ownerName" class="form-input w-full px-3 sm:px-6 py-2.5 sm:py-4 text-sm text-white rounded-lg sm:rounded-none placeholder-white/20 font-light" placeholder="First and Last Name" required>
                            <div class="error-msg" data-for="ownerName"></div>
                        </div>
                        <div class="grid grid-cols-2 sm:grid-cols-2 gap-3 sm:gap-8">
                            <div class="group">
                                <label class="text-[9px] sm:text-[10px] uppercase tracking-[0.15em] text-white/50 block mb-1.5 sm:mb-3 group-focus-within:text-white transition-colors">Email</label>
                                <input type="email" name="email" class="form-input w-full px-3 sm:px-6 py-2.5 sm:py-4 text-sm text-white rounded-lg sm:rounded-none placeholder-white/20 font-light" placeholder="name@site.com" required>
                                <div class="error-msg" data-for="email"></div>
                            </div>
                            <div class="group">
                                <label class="text-[9px] sm:text-[10px] uppercase tracking-[0.15em] text-white/50 block mb-1.5 sm:mb-3 group-focus-within:text-white transition-colors">Phone</label>
                                <input type="tel" name="phone" id="phone-input" class="form-input w-full px-3 sm:px-6 py-2.5 sm:py-4 text-sm text-white rounded-lg sm:rounded-none placeholder-white/20 font-light" placeholder="(555) 000-0000" required>
                                <div class="error-msg" data-for="phone"></div>
                            </div>
                        </div>
                        <div class="group">
                            <label class="text-[9px] sm:text-[10px] uppercase tracking-[0.15em] text-white/50 block mb-1.5 sm:mb-3 group-focus-within:text-white transition-colors">Address</label>
                            <input type="text" name="address" class="form-input w-full px-3 sm:px-6 py-2.5 sm:py-4 text-sm text-white rounded-lg sm:rounded-none placeholder-white/20 font-light" placeholder="Street, City, State, Zip" required>
                            <div class="error-msg" data-for="address"></div>
                        </div>
                        <div class="pt-2 sm:pt-3">
                            <button type="submit" class="btn-primary h-11 sm:h-14 rounded-lg sm:rounded-none">Continue</button>
                            <p class="mt-3 sm:mt-5 text-center text-[10px] uppercase tracking-[0.12em] text-white/25">Secure setup. Takes less than 2 minutes.</p>
                        </div>
                    </form>
                </div>

                <div class="mt-6 sm:mt-10 text-center animate-fade-in delay-200 opacity-0">
                    <div class="flex justify-center gap-5 sm:gap-6 text-[9px] uppercase tracking-widest text-white/10">
                        <a href="#" class="hover:text-white/20 transition-colors">Privacy</a>
                        <a href="#" class="hover:text-white/20 transition-colors">Terms</a>
                    </div>
                </div>
            </div>

            <!-- ==================== STEP 2: VERIFY PHONE ==================== -->
            <div id="step-2" class="step-section">
                <div class="text-center mb-6 sm:mb-10 animate-fade-in opacity-0">
                    <span class="text-[10px] tracking-[0.25em] text-white/50 uppercase block mb-3 sm:mb-4">Onboarding</span>
                    <div class="flex items-center justify-center gap-2 mb-6 sm:mb-10" id="dots-2">
                        <div class="progress-dot completed"></div>
                        <div class="progress-dot active-green"></div>
                        <div class="progress-dot"></div>
                    </div>
                    <h1 class="text-2xl sm:text-5xl font-medium tracking-tight mb-2 sm:mb-4" style="letter-spacing:-0.02em">Verify your phone</h1>
                    <p class="text-xs sm:text-sm text-white/55 font-light leading-relaxed" id="verify-subtitle">We sent a 6-digit code to your phone.</p>
                </div>

                <div class="glass-panel rounded-[20px] sm:rounded-xl p-4 sm:px-10 sm:py-10 animate-fade-in delay-100 opacity-0">
                    <form id="form-2" class="flex flex-col gap-4 sm:space-y-6" novalidate>
                        <div class="group">
                            <label class="text-[9px] sm:text-[10px] uppercase tracking-[0.15em] text-white/50 block mb-1.5 sm:mb-3 group-focus-within:text-white transition-colors">Verification Code</label>
                            <input type="text" name="code" id="otp-input" maxlength="6" inputmode="numeric" pattern="[0-9]*" autocomplete="one-time-code" class="form-input w-full px-3 sm:px-6 py-2.5 sm:py-4 text-sm sm:text-lg text-white rounded-lg sm:rounded-none placeholder-white/20 font-light tracking-[0.3em] text-center" placeholder="000000" required>
                            <div class="error-msg" data-for="code"></div>
                        </div>
                        <div class="pt-2 sm:pt-3">
                            <button type="submit" class="btn-primary h-11 sm:h-14 rounded-lg sm:rounded-none">Verify</button>
                            <p class="mt-4 text-center">
                                <span class="resend-link" id="resend-btn">Resend code</span>
                            </p>
                        </div>
                    </form>
                </div>

                <div class="mt-6 sm:mt-10 text-center animate-fade-in delay-200 opacity-0">
                    <div class="flex justify-center gap-5 sm:gap-6 text-[9px] uppercase tracking-widest text-white/10">
                        <a href="#" class="hover:text-white/20 transition-colors">Privacy</a>
                        <a href="#" class="hover:text-white/20 transition-colors">Terms</a>
                    </div>
                </div>
            </div>

            <!-- ==================== STEP 3: PAYMENT ==================== -->
            <div id="step-3" class="step-section">
                <div class="text-center mb-6 sm:mb-10 animate-fade-in opacity-0">
                    <span class="text-[10px] tracking-[0.25em] text-white/50 uppercase block mb-3 sm:mb-4">Onboarding</span>
                    <div class="flex items-center justify-center gap-2 mb-6 sm:mb-10" id="dots-3">
                        <div class="progress-dot completed"></div>
                        <div class="progress-dot completed"></div>
                        <div class="progress-dot active-green"></div>
                    </div>
                    <h1 class="text-2xl sm:text-5xl font-medium tracking-tight mb-2 sm:mb-4" style="letter-spacing:-0.02em">Start your free trial</h1>
                    <p class="text-xs sm:text-sm text-white/55 font-light leading-relaxed">14 days free. $99/mo after. Cancel anytime via text.</p>
                </div>

                <div class="glass-panel rounded-[20px] sm:rounded-xl p-4 sm:px-10 sm:py-10 animate-fade-in delay-100 opacity-0">
                    <div class="flex flex-col gap-4 sm:space-y-6">
                        <div class="pt-2 sm:pt-2">
                            <button type="button" id="btn-payment" class="btn-primary h-11 sm:h-14 rounded-lg sm:rounded-none">Continue to payment</button>
                            <p class="mt-3 sm:mt-5 text-center text-[10px] uppercase tracking-[0.12em] text-white/25">Secure checkout powered by Stripe.</p>
                        </div>
                    </div>
                </div>

                <div class="mt-6 sm:mt-10 text-center animate-fade-in delay-200 opacity-0">
                    <div class="flex justify-center gap-5 sm:gap-6 text-[9px] uppercase tracking-widest text-white/10">
                        <a href="#" class="hover:text-white/20 transition-colors">Privacy</a>
                        <a href="#" class="hover:text-white/20 transition-colors">Terms</a>
                    </div>
                </div>
            </div>

            <!-- ==================== STEP 4: CONNECT GOOGLE ==================== -->
            <div id="step-4" class="step-section">
                <div class="text-center mb-6 sm:mb-10 animate-fade-in opacity-0">
                    <span class="text-[10px] tracking-[0.25em] text-white/50 uppercase block mb-3 sm:mb-4">Onboarding</span>
                    <div class="flex items-center justify-center gap-2 mb-6 sm:mb-10" id="dots-4">
                        <div class="progress-dot completed"></div>
                        <div class="progress-dot completed"></div>
                        <div class="progress-dot active-green"></div>
                    </div>
                    <h1 class="text-2xl sm:text-5xl font-medium tracking-tight mb-2 sm:mb-4" style="letter-spacing:-0.02em">Connect Your Google Business Profile</h1>
                    <p class="text-xs sm:text-sm text-white/55 font-light leading-relaxed max-w-xs sm:max-w-md mx-auto">We'll monitor your reviews and draft replies automatically. You can approve everything via SMS.</p>
                </div>

                <div class="glass-panel rounded-[20px] sm:rounded-xl p-4 sm:px-10 sm:py-10 animate-fade-in delay-100 opacity-0">
                    <div class="flex flex-col gap-4 sm:space-y-6">
                        <div class="pt-2 sm:pt-2">
                            <button type="button" id="btn-google" class="btn-primary h-11 sm:h-14 rounded-lg sm:rounded-none flex items-center justify-center gap-2">
                                Connect Google
                            </button>
                            <p class="mt-3 sm:mt-5 text-center text-[10px] uppercase tracking-[0.12em] text-white/25">Secure OAuth connection. We never post without your approval.</p>
                        </div>
                    </div>
                </div>

                <div class="mt-6 sm:mt-10 text-center animate-fade-in delay-200 opacity-0">
                    <div class="flex justify-center gap-5 sm:gap-6 text-[9px] uppercase tracking-widest text-white/10">
                        <a href="#" class="hover:text-white/20 transition-colors">Privacy</a>
                        <a href="#" class="hover:text-white/20 transition-colors">Terms</a>
                    </div>
                </div>
            </div>

            <!-- ==================== STEP 5: ALL SET ==================== -->
            <div id="step-5" class="step-section">
                <div class="text-center mb-6 sm:mb-10 animate-fade-in opacity-0">
                    <span class="text-[10px] tracking-[0.25em] text-white/50 uppercase block mb-3 sm:mb-4">Onboarding</span>
                    <div class="flex items-center justify-center gap-2 mb-6 sm:mb-10" id="dots-5">
                        <div class="progress-dot completed"></div>
                        <div class="progress-dot completed"></div>
                        <div class="progress-dot completed"></div>
                    </div>
                    <div class="flex justify-center mb-6">
                        <svg width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="32" cy="32" r="30" stroke="#4ade80" stroke-width="2" opacity="0.3"/>
                            <circle cx="32" cy="32" r="30" stroke="#4ade80" stroke-width="2" class="check-animate" style="stroke-dasharray:189;stroke-dashoffset:189;animation:checkDraw 0.8s ease-out 0.2s forwards"/>
                            <path d="M20 33L28 41L44 25" stroke="#4ade80" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="check-animate"/>
                        </svg>
                    </div>
                    <h1 class="text-2xl sm:text-5xl font-medium tracking-tight mb-2 sm:mb-4" style="letter-spacing:-0.02em">You're all set</h1>
                    <p class="text-xs sm:text-sm text-white/55 font-light leading-relaxed">We're monitoring your reviews 24/7. Check your phone for a welcome text.</p>
                </div>

                <div class="glass-panel rounded-[20px] sm:rounded-xl p-4 sm:px-10 sm:py-10 animate-fade-in delay-100 opacity-0">
                    <div class="flex flex-col gap-4 sm:space-y-6">
                        <div class="pt-2 sm:pt-2">
                            <a href="https://maitreo.com" class="btn-primary h-11 sm:h-14 rounded-lg sm:rounded-none flex items-center justify-center">Go to Maitreo</a>
                        </div>
                    </div>
                </div>

                <div class="mt-6 sm:mt-10 text-center animate-fade-in delay-200 opacity-0">
                    <div class="flex justify-center gap-5 sm:gap-6 text-[9px] uppercase tracking-widest text-white/10">
                        <a href="#" class="hover:text-white/20 transition-colors">Privacy</a>
                        <a href="#" class="hover:text-white/20 transition-colors">Terms</a>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
    (function() {
        // ── Config ──
        const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3001'
            : 'https://restaurant-saas-backend-pbbx.onrender.com';

        let state = { restaurantId: null, phone: '' };

        // ── Helpers ──
        const $ = s => document.querySelector(s);
        const $$ = s => document.querySelectorAll(s);

        function getParam(k) {
            return new URLSearchParams(window.location.search).get(k);
        }
        function setParam(k, v) {
            const u = new URL(window.location);
            u.searchParams.set(k, v);
            window.history.replaceState({}, '', u);
        }

        function showStep(n) {
            $$('.step-section').forEach(s => s.classList.remove('active'));
            const el = $(`#step-${n}`);
            if (el) {
                el.classList.add('active');
                // Re-trigger animations
                el.querySelectorAll('.animate-fade-in').forEach(a => {
                    a.style.animation = 'none';
                    a.offsetHeight; // reflow
                    a.style.animation = '';
                });
            }
        }

        function formatPhone(v) {
            const d = v.replace(/\D/g, '').slice(0, 10);
            if (d.length === 0) return '';
            if (d.length <= 3) return `(${d}`;
            if (d.length <= 6) return `(${d.slice(0,3)}) ${d.slice(3)}`;
            return `(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6)}`;
        }
        function rawPhone(v) { return v.replace(/\D/g, ''); }

        function showError(name, msg) {
            const el = document.querySelector(`.error-msg[data-for="${name}"]`);
            const inp = document.querySelector(`[name="${name}"]`);
            if (el) { el.textContent = msg; el.classList.add('visible'); }
            if (inp) inp.classList.add('input-error');
        }
        function clearErrors(form) {
            form.querySelectorAll('.error-msg').forEach(e => { e.textContent = ''; e.classList.remove('visible'); });
            form.querySelectorAll('.form-input').forEach(e => e.classList.remove('input-error'));
        }

        async function api(path, opts = {}) {
            const res = await fetch(`${API_URL}${path}`, {
                headers: { 'Content-Type': 'application/json', ...opts.headers },
                ...opts,
                body: opts.body ? JSON.stringify(opts.body) : undefined
            });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.error || err.message || `HTTP ${res.status}`);
            }
            return res.json();
        }

        // ── Phone formatting ──
        const phoneInput = $('#phone-input');
        if (phoneInput) {
            phoneInput.addEventListener('input', function() {
                const pos = this.selectionStart;
                const prev = this.value;
                this.value = formatPhone(this.value);
            });
        }

        // ── Label focus behavior ──
        function bindLabels(container) {
            container.querySelectorAll('input').forEach(input => {
                const label = input.parentElement.querySelector('label');
                if (!label) return;
                input.addEventListener('focus', () => label.style.color = 'white');
                input.addEventListener('blur', () => { if (!input.value) label.style.color = ''; });
                if (input.value) label.style.color = 'white';
            });
        }
        bindLabels(document);

        // ── Step 1: Register ──
        $('#form-1').addEventListener('submit', async function(e) {
            e.preventDefault();
            clearErrors(this);
            const fd = new FormData(this);
            const data = {
                name: fd.get('name')?.trim(),
                ownerName: fd.get('ownerName')?.trim(),
                email: fd.get('email')?.trim(),
                phone: rawPhone(fd.get('phone') || ''),
                address: fd.get('address')?.trim()
            };

            // Validate
            let valid = true;
            if (!data.name) { showError('name', 'Restaurant name is required'); valid = false; }
            if (!data.ownerName) { showError('ownerName', 'Owner name is required'); valid = false; }
            if (!data.email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.email)) { showError('email', 'Valid email is required'); valid = false; }
            if (data.phone.length < 10) { showError('phone', 'Valid 10-digit phone is required'); valid = false; }
            if (!data.address) { showError('address', 'Address is required'); valid = false; }
            if (!valid) return;

            const btn = this.querySelector('button[type="submit"]');
            btn.disabled = true; btn.textContent = 'Setting up...';
            try {
                const res = await api('/onboarding/register', { method: 'POST', body: data });
                state.restaurantId = res.restaurantId;
                state.phone = data.phone;
                setParam('rid', state.restaurantId);
                // Send OTP
                await api('/onboarding/otp/send', { method: 'POST', body: { restaurantId: state.restaurantId, phone: state.phone } });
                // Update subtitle
                const masked = `(${state.phone.slice(0,3)}) ${state.phone.slice(3,6)}-${state.phone.slice(6)}`;
                $('#verify-subtitle').textContent = `We sent a 6-digit code to ${masked}`;
                showStep(2);
            } catch (err) {
                showError('name', err.message);
            } finally {
                btn.disabled = false; btn.textContent = 'Continue';
            }
        });

        // ── Step 2: Verify OTP ──
        const otpInput = $('#otp-input');
        otpInput.addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '').slice(0, 6);
        });

        $('#form-2').addEventListener('submit', async function(e) {
            e.preventDefault();
            clearErrors(this);
            const code = otpInput.value.trim();
            if (code.length !== 6) { showError('code', 'Enter the 6-digit code'); return; }

            const btn = this.querySelector('button[type="submit"]');
            btn.disabled = true; btn.textContent = 'Verifying...';
            try {
                await api('/onboarding/otp/verify', { method: 'POST', body: { restaurantId: state.restaurantId, code } });
                showStep(3);
            } catch (err) {
                showError('code', err.message);
            } finally {
                btn.disabled = false; btn.textContent = 'Verify';
            }
        });

        $('#resend-btn').addEventListener('click', async function() {
            this.textContent = 'Sending...';
            this.style.pointerEvents = 'none';
            try {
                await api('/onboarding/otp/send', { method: 'POST', body: { restaurantId: state.restaurantId, phone: state.phone } });
                this.textContent = 'Code sent!';
                setTimeout(() => { this.textContent = 'Resend code'; this.style.pointerEvents = ''; }, 3000);
            } catch (err) {
                this.textContent = 'Failed — try again';
                setTimeout(() => { this.textContent = 'Resend code'; this.style.pointerEvents = ''; }, 3000);
            }
        });

        // ── Step 3: Payment ──
        $('#btn-payment').addEventListener('click', async function() {
            this.disabled = true; this.textContent = 'Redirecting...';
            try {
                const res = await api('/onboarding/stripe/create-session', { method: 'POST', body: { restaurantId: state.restaurantId } });
                if (res.url) window.location.href = res.url;
                else throw new Error('No checkout URL returned');
            } catch (err) {
                alert(err.message);
            } finally {
                this.disabled = false; this.textContent = 'Continue to payment';
            }
        });

        // ── Step 4: Google Connect ──
        $('#btn-google').addEventListener('click', function() {
            const returnUrl = `${window.location.origin}${window.location.pathname}?rid=${state.restaurantId}&step=5`;
            window.location.href = `${API_URL}/auth/google/start?restaurant_id=${state.restaurantId}&return_url=${encodeURIComponent(returnUrl)}`;
        });

        // ── Step 5: Complete ──
        async function completeOnboarding() {
            try {
                await api('/onboarding/complete', { method: 'POST', body: { restaurantId: state.restaurantId } });
            } catch (_) {}
        }

        // ── Resume Logic ──
        async function init() {
            const rid = getParam('rid');
            const stepParam = getParam('step');

            if (rid) {
                state.restaurantId = rid;
                try {
                    const status = await api(`/onboarding/status?rid=${rid}`);
                    state.restaurantId = status.restaurantId || rid;
                    state.phone = status.phone || '';

                    // Stripe return
                    if (stepParam === '4') {
                        showStep(4);
                        return;
                    }
                    if (stepParam === '5') {
                        showStep(5);
                        completeOnboarding();
                        return;
                    }

                    // Auto-advance to first incomplete step
                    if (status.onboarding_complete) { showStep(5); return; }
                    if (status.google_connected) { showStep(5); completeOnboarding(); return; }
                    if (status.stripe_active) { showStep(4); return; }
                    if (status.phone_verified) { showStep(3); return; }
                    // Phone not verified — go to step 2, send OTP
                    showStep(2);
                    if (state.phone) {
                        const masked = `(${state.phone.slice(0,3)}) ${state.phone.slice(3,6)}-${state.phone.slice(6)}`;
                        $('#verify-subtitle').textContent = `We sent a 6-digit code to ${masked}`;
                    }
                    try { await api('/onboarding/otp/send', { method: 'POST', body: { restaurantId: state.restaurantId, phone: state.phone } }); } catch(_){}
                } catch (err) {
                    // Status fetch failed — start from step 1
                    showStep(1);
                }
            } else {
                showStep(1);
            }
        }

        init();
    })();
    </script>
</body>
</html>
